var __extends = this.__extends || function (e, t) { function i() { this.constructor = e } i.prototype = t.prototype, e.prototype = new i }, Utilities; !function (e) { function t(e, t) { var i = moment(e), r = moment(t); return e && t && i && r ? (i.hours(0).minutes(0).seconds(0).milliseconds(0), r.hours(0).minutes(0).seconds(0).milliseconds(0), i.diff(r, "days")) : 0 / 0 } function i() { var e = ko.observable(!1); return e.register = function (t) { t.subscribe(function () { e(!0) }) }, e.reset = function () { return e(!1) }, e } e.daysDiff = t, e.dirtyFlag = i; var r = function () { function e(e, t) { "undefined" == typeof e && (e = "abcdefghijklmnopqrstuvwxyz1234567890"), "undefined" == typeof t && (t = 8), this.chars = e, this.length = t } return e.prototype.generate = function (e) { "undefined" == typeof e && (e = ""); var t = this.chars, i = t.length; return e + _.map(_.range(this.length), function () { return t[_.random(0, i)] }).join("") }, e }(); e.IdGenerator = r, e.idGenerator = new r; var n = function () { function e() { var e = this, t = this.constructor; if (!t.__cb__) { t.__cb__ = {}; for (var i in this) { var r = this[i]; "function" == typeof r && -1 == i.indexOf("__cb__") && (t.__cb__[i] = r) } } for (var i in t.__cb__) !function (t, i) { e[t] = function () { return i.apply(e, Array.prototype.slice.call(arguments)) } }(i, t.__cb__[i]) } return e }(); e.HasCallbacks = n, function (t) { function i(e, t, i) { var r = _.map(ko.toJS(t), function (e) { return e.Text }), n = r.length + 1; if (i && (i.Text && (i = i.Text), _.isString(i))) { if (-1 == r.indexOf(i)) return i; e = i, n = 2 } for (; ;) { var i = e + n++; if (-1 == r.indexOf(i)) return i } } function r(t, r, n, s) { var a; if (s && s.Key) a = { Key: s.Key, Text: ko.observable(s.Text) }; else { var o = i(r, t, s); a = { Key: e.idGenerator.generate(n), Text: ko.observable(o) } } return t.push(a), a } function n(e, t, i) { if ("undefined" == typeof i && (i = "Key"), !e().length) return null; if (_.isString(t)) return e.remove(function (e) { return e[i] == t }); var r = _.isNumber(t) ? t : e.indexOf(t); return e.splice(r, 1)[0] } t.addKeyObservableText = r, t.removeItem = n }(e.ObservableArrays || (e.ObservableArrays = {})); e.ObservableArrays }(Utilities || (Utilities = {})); var MyMenu; !function (e) { var t = function () { function e(e, t, i) { var r = this, n = _.isFunction(e), s = _.isFunction(t), a = _.isFunction(i); if (this.StartDate = n ? function () { return moment(e()) } : function () { return moment(e) }, this.WeeksQuantity = s ? t : function () { return t }, a ? this.FirstWeekIdx = function () { return i() || 0 } : (i = i || 0, this.FirstWeekIdx = function () { return i }), n || s || a) this.ZeroWeekZeroDay = function () { return r.calculateZeroWeekZeroDay() }; else { var o = this.calculateZeroWeekZeroDay(); this.ZeroWeekZeroDay = function () { return o } } } return e.prototype.calculateZeroWeekZeroDay = function () { return this.StartDate().day(0).add("weeks", -1 * this.FirstWeekIdx()) }, e.prototype.week = function (e) { var t = this.WeeksQuantity(), i = moment(e).day(0), r = i.diff(this.ZeroWeekZeroDay(), "weeks"), n = 0 > r ? t + r % t : r % t; return n }, e.prototype.day = function (e) { var t = moment(e).day(); return t }, e.prototype.match = function (e, t, i) { return e == this.week(i) && t == this.day(i) }, e.prototype.near = function (e, t, i) { var r = this.WeeksQuantity(); if (e >= r) return null; var n = moment(i); if (!n.isValid) return null; for (; !this.match(e, t, n) ;) n.add("days", 1); return n }, e }(); e.CalendarHelper = t, e.days = function () { var e = [1, 2, 3, 4, 5], t = function () { return e }; return t.getName = function (e) { return moment().day(e).format("dddd") }, t.isValid = function (t) { return e.indexOf(t) >= 0 }, t }(); var i = function (t) { function i(e) { var i = this; t.call(this), this.isDirty = Utilities.dirtyFlag(), this.WeeksQuantity = ko.observable(0), this.isDirty.register(this.WeeksQuantity), this.Weeks = ko.computed(function () { return _.map(_.range(i.WeeksQuantity()), function (e) { return { Key: e.toString(), Text: "Semana " + (e + 1) } }) }), this.WeekStorageReset(e) } return __extends(i, t), i.prototype.setWeeksQuantity = function (e) { this.WeeksQuantity(e) }, i.prototype.reset = function (e) { this.WeekStorageReset(e) }, i.prototype.WeekStorageReset = function (e) { var t; if (this.setWeeksQuantity(0), this.items = [], e) for (t = 0; e > t; t++) this.addWeek() }, i.prototype.addWeek = function () { for (var e = [], t = 0; 7 > t; t++) { var i = this.createNewItem(); e.push(i) } this.items.push(e), this.setWeeksQuantity(this.WeeksQuantity() + 1) }, i.prototype.removeWeek = function () { var e = this.WeeksQuantity(); e > 0 && (this.setWeeksQuantity(e - 1), this.items.pop()) }, i.prototype.createNewItem = function () { return null }, i.prototype.getItem = function (t, i) { return e.days.isValid(i) && t < this.WeeksQuantity() ? this.items[t][i] : null }, i.prototype.eachWeek = function (e) { _.each(this.items, function (t, i) { return e(t, i) }) }, i.prototype.eachDay = function (e) { this.eachWeek(function (t, i) { return _.each(t, function (t, r) { return e(t, i, r) }) }) }, i }(Utilities.HasCallbacks); e.WeekStorage = i; var r = function () { function e() { this.OptionKey = ko.observable(""), this.PlaceKey = ko.observable("") } return e }(); e.DayChoice = r; var n = function (e) { function t(t) { e.call(this), this.Date = ko.observable(""), this.Cancel = ko.observable(!1), this.Comment = ko.observable(""), t && (this.OptionKey(t.OptionKey), this.PlaceKey(t.PlaceKey), this.Date(t.Date), this.Cancel(t.Cancel), this.Comment(t.Comment)) } return __extends(t, e), t }(r), s = function (e) { function i(i, r, n) { e.call(this, i.WeeksQuantity()), this.menu = i, this.MenuId = ko.observable(""), this.DefaultPlaceKey = ko.observable(""), this.Overrides = ko.observableArray([]), this.now = ko.observable(), this.isDirty.register(this.MenuId), this.isDirty.register(this.DefaultPlaceKey), this.isDirty.register(this.Overrides), this.EmployeeMenuDefinitionReset(r), this.calendarHelper = new t(i.StartDate, i.WeeksQuantity, i.FirstWeekIdx), this.now(n) } return __extends(i, e), i.prototype.reset = function (t) { e.prototype.reset.call(this, this.menu.WeeksQuantity()), this.EmployeeMenuDefinitionReset(t), this.isDirty(!1) }, i.prototype.dateFormated = function (e) { var t = moment(this.now()).hours(0).minutes(0).seconds(0).milliseconds(0); if (e = moment(e), !e) return null; e.hours(0).minutes(0).seconds(0).milliseconds(0); var i = e.diff(t, "days", !0), r = e.format("D [de] MMMM [de] YYYY"), n = !1, s = !1, a = 0 > i; return a ? r = "¡Ya pasó! (" + r + ")" : 0 == i ? (s = !0, n = !0, r = "Hoy") : 1 == i ? (n = !0, r = "Mañana (" + r + ")") : 2 == i ? (n = !0, r = "Pasado mañana (" + r + ")") : t.day() >= 4 && 5 > i && 1 == e.day() ? (n = !0, r = "Próximo Lunes (" + r + ")") : 7 > i && (r = r + " (en " + i + " días)"), { old: a, today: s, near: n, text: r } }, i.prototype.nearFormated = function (e, t) { var i = moment(this.now()), r = this.calendarHelper.near(+e, t, i); return this.dateFormated(r) }, i.prototype.createNewItem = function () { var e = new r; return this.isDirty.register(e.OptionKey), this.isDirty.register(e.PlaceKey), e }, i.prototype.eachWeek = function (t) { e.prototype.eachWeek.call(this, t) }, i.prototype.eachDay = function (t) { e.prototype.eachDay.call(this, t) }, i.prototype.getItem = function (t, i) { return e.prototype.getItem.call(this, t, i) }, i.prototype.getMenuChoice = function (e, t) { var i = this.getItem(e, t); return i && i.OptionKey }, i.prototype.getPlaceChoice = function (e, t) { var i = this.getItem(e, t); return i && i.PlaceKey }, i.prototype.getChoicesByDate = function (e) { var t = this.calendarHelper.week(e), i = this.calendarHelper.day(e), r = this.DefaultPlaceKey(), n = null, s = null, a = null, o = null, u = null, l = this.getItem(t, i); l && (r = l.PlaceKey() || r, n = l.OptionKey() || n); var c = _.last(_.filter(this.Overrides(), function (t) { return 0 === Utilities.daysDiff(t.Date(), e) })); c && (s = c.Comment(), c.Cancel() ? (r = null, n = null) : (r = c.PlaceKey() || r, n = c.OptionKey() || n)), a = n && this.menu.getFood(t, i, n)(); var h = r && _.find(this.menu.Places(), function (e) { return e.Key == r }); u = h ? h.Text() : null; var y = n && _.find(this.menu.Options(), function (e) { return e.Key == n }); return o = y ? y.Text() : null, a && r || (u = null, o = null, a = null), { Date: e, Place: u, Option: o, Food: a, Comment: s, WeekIdx: t, DayIdx: i, IsOrdered: !1, HasTomorrowBeenOrdered: !1 } }, i.prototype.getDefaultPlaceLabel = function () { var e = this.DefaultPlaceKey(), t = this.menu.Places(), i = _.find(t, function (t) { return t.Key == e }); return i ? "Lugar por defecto (" + i.Text() + ")" : "Seleccione un lugar (no se definió el lugar por defecto)" }, i.prototype.getDayWeekLabel = function (e) { var t = moment(ko.utils.unwrapObservable(e)); return t && t.isValid ? t.format("dddd") + " de Semana " + (this.calendarHelper.week(t) + 1) : "Seleccione un día válido" }, i.prototype.getDayWeekOptionOverrideInfo = function (e, t) { var i = moment(ko.utils.unwrapObservable(e)); if (!i || !i.isValid) return "Atención! Seleccione un día válido"; var r = this.calendarHelper.week(i), n = this.calendarHelper.day(i), s = ko.utils.unwrapObservable(t) || ko.utils.unwrapObservable(this.getMenuChoice(r, n)), a = ko.utils.unwrapObservable(this.menu.getFood(r, n, s)); return a || "Atención! no hay comida seleccionada para este día" }, i.prototype.getDayWeekPlaceOverrideInfo = function (e, t) { var i = moment(ko.utils.unwrapObservable(e)); if (!i || !i.isValid) return "Atención! Seleccione un día válido"; var r = this.calendarHelper.week(i), n = this.calendarHelper.day(i), s = ko.utils.unwrapObservable(t) || ko.utils.unwrapObservable(this.getPlaceChoice(r, n)) || ko.utils.unwrapObservable(this.DefaultPlaceKey), a = this.menu.Places(), o = _.find(a, function (e) { return e.Key == s }), u = o && o.Text; return u || "Atención! no hay lugar seleccionado para este día" }, i.prototype.EmployeeMenuDefinitionReset = function (e) { var t = this; e = _.extend({ UserName: "", Id: "", EmployeeName: "", DefaultPlaceKey: "" }, e), this.MenuId(e.MenuId), this.Id = e.Id, this.UserName = e.UserName, this.EmployeeName = e.EmployeeName, this.DefaultPlaceKey(e.DefaultPlaceKey), e.WeeklyChoices && _.each(e.WeeklyChoices, function (e) { var i = t.getItem(e.WeekIdx, e.DayIdx); i && (i.OptionKey(e.OptionKey), i.PlaceKey(e.PlaceKey)) }), this.Overrides.removeAll(), e.Overrides && _.each(e.Overrides, function (e) { var i = new n(e); t.Overrides.push(i), t.isDirty.register(i.OptionKey), t.isDirty.register(i.PlaceKey), t.isDirty.register(i.Date), t.isDirty.register(i.Cancel), t.isDirty.register(i.Comment) }) }, i.prototype.exportData = function () { var e = { MenuId: this.MenuId(), Id: this.Id, UserName: this.UserName, EmployeeName: this.EmployeeName, DefaultPlaceKey: this.DefaultPlaceKey(), WeeklyChoices: [], Overrides: [] }, t = e.WeeklyChoices; return this.eachDay(function (e, i, r) { var n = e.OptionKey(); if (n) { var s = { WeekIdx: i, DayIdx: r, OptionKey: n }, a = e.PlaceKey(); a && (s.PlaceKey = a), t.push(s) } }), e.Overrides = ko.toJS(this.Overrides), e }, i.prototype.addOverride = function () { var e = new n; this.Overrides.push(e), this.isDirty.register(e.OptionKey), this.isDirty.register(e.PlaceKey), this.isDirty.register(e.Date), this.isDirty.register(e.Cancel), this.isDirty.register(e.Comment) }, i.prototype.removeOverride = function (e) { Utilities.ObservableArrays.removeItem(this.Overrides, e, "date") }, i }(i); e.EmployeeMenuDefinition = s; var a = function (e) { function t(t) { e.call(this, t && t.WeeksQuantity), this.Id = ko.observable(""), this.Title = ko.observable(""), this.Options = ko.observableArray(), this.Places = ko.observableArray(), this.StartDate = ko.observable(""), this.EndDate = ko.observable(""), this.DeadlineTime = ko.observable(""), this.LastOrderDate = ko.observable(""), this.FirstWeekIdx = ko.observable(0), this.isDirty.register(this.Id), this.isDirty.register(this.Title), this.isDirty.register(this.Options), this.isDirty.register(this.Places), this.isDirty.register(this.StartDate), this.isDirty.register(this.EndDate), this.isDirty.register(this.DeadlineTime), this.isDirty.register(this.FirstWeekIdx), this.isDirty.register(this.LastOrderDate), this.MenuDefinitionReset(t) } return __extends(t, e), t.defaultData = { Id: "Menu/DefaultMenu", Title: "Nuevo Menú", FirstWeekIdx: 0, WeeksQuantity: 0, Options: [], Places: [], StartDate: "2000-01-01", EndDate: "2100-01-01", LastOrderDate: "2000-01-01", DeadlineTime: "09:30", Foods: [] }, t.idGenerator = new Utilities.IdGenerator, t.prototype.createNewItem = function () { var e = this, t = {}; return this.Options && _.each(this.Options(), function (i) { var r = ko.observable(""); t[i.Key] = r, e.isDirty.register(r) }), t }, t.prototype.getItem = function (t, i) { return e.prototype.getItem.call(this, t, i) }, t.prototype.getFood = function (e, t, i) { this.WeeksQuantity(), this.Options(); var r = this.getItem(e, t); return r && r[i] }, t.prototype.eachWeek = function (t) { e.prototype.eachWeek.call(this, t) }, t.prototype.eachDay = function (t) { e.prototype.eachDay.call(this, t) }, t.prototype.MenuDefinitionReset = function (e) { var i = this; e = $.extend({}, t.defaultData, e); var r; this.Id(e.Id), this.Title(e.Title), this.StartDate(e.StartDate), this.EndDate(e.EndDate), this.FirstWeekIdx(e.FirstWeekIdx), this.DeadlineTime(e.DeadlineTime), this.LastOrderDate(e.LastOrderDate), this.Places.removeAll(); for (r in e.Places) this.addPlace(e.Places[r]); this.Options.removeAll(); for (r in e.Options) this.addOption(e.Options[r]); e && e.Foods && _.each(e.Foods, function (e) { var t = i.getFood(e.WeekIdx, e.DayIdx, e.OptionKey); t && t(e.Food) }), this.isDirty.reset() }, t.prototype.reset = function (t) { e.prototype.reset.call(this, t && t.WeeksQuantity), this.MenuDefinitionReset(t) }, t.prototype.exportData = function () { var e = { Id: this.Id(), DeadlineTime: this.DeadlineTime(), LastOrderDate: this.LastOrderDate(), Title: this.Title(), FirstWeekIdx: this.FirstWeekIdx(), WeeksQuantity: this.WeeksQuantity(), StartDate: this.StartDate(), EndDate: this.EndDate(), Places: ko.toJS(this.Places), Options: ko.toJS(this.Options), Foods: [] }; return this.eachDay(function (t, i, r) { var n; for (var s in t) (n = t[s]()) && e.Foods.push({ WeekIdx: i, DayIdx: r, OptionKey: s, Food: n }) }), e }, t.prototype.addOption = function (e) { var t = this, i = Utilities.ObservableArrays.addKeyObservableText(this.Options, "Menú ", "menu_", e); this.isDirty.register(i.Text), this.eachDay(function (e) { var r = ko.observable(""); e[i.Key] = r, t.isDirty.register(r) }), this.Options.valueHasMutated() }, t.prototype.removeOption = function (e) { var t = Utilities.ObservableArrays.removeItem(this.Options, e); t && this.eachDay(function (e) { return delete e[t.Key] }) }, t.prototype.addPlace = function (e) { var e = Utilities.ObservableArrays.addKeyObservableText(this.Places, "Lugar ", "place_", e); this.isDirty.register(e.Text) }, t.prototype.removePlace = function (e) { Utilities.ObservableArrays.removeItem(this.Places, e) }, t }(i); e.MenuDefinition = a }(MyMenu || (MyMenu = {}));
